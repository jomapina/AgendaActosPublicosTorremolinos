<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda √önica - Actos P√∫blicos</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <!-- Libraries -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>

<body class="theme-light">

    <div class="app-shell">
        <!-- GLOBAL NAVIGATION (4 TABS) -->
        <nav class="main-nav">
            <div class="nav-brand">
                <i data-lucide="calendar-days"></i>
                <span>Agenda √önica Torremolinos</span>
            </div>
            <div class="nav-links">
                <button class="nav-item" onclick="App.router.navigate('filters')">
                    <i data-lucide="filter"></i> Filtros
                </button>
                <button class="nav-item active" onclick="App.router.navigate('agenda')">
                    <i data-lucide="calendar"></i> Agenda
                </button>
                <button class="nav-item" onclick="App.router.navigate('reports')">
                    <i data-lucide="bar-chart-3"></i> Informes
                </button>
                <button class="nav-item" onclick="App.router.navigate('incidents')">
                    <i data-lucide="alert-triangle"></i> Incidencias
                </button>
            </div>
            <div class="nav-actions">
                <div class="last-updated-badge" id="lastUpdated">...</div>
                <button class="btn-icon" onclick="App.data.refresh()" title="Refrescar Datos">
                    <i data-lucide="refresh-cw"></i>
                </button>
            </div>
        </nav>

        <!-- TAB 1: FILTERS (GLOBAL CONTROL) -->
        <main id="tab-filters" class="view-container">
            <div class="split-layout">
                <!-- Left: Full Filter Panel -->
                <aside class="filter-panel-full">
                    <header>
                        <h3>Configuraci√≥n de Filtros Globales</h3>
                        <button class="btn-text" onclick="App.filters.clear()">Limpiar todo</button>
                    </header>
                    <div class="filter-scroll-area">
                        <!-- Search -->
                        <div class="form-group">
                            <label>B√∫squeda Texto</label>
                            <input type="text" id="globalSearch" class="input-field"
                                placeholder="Buscar por t√≠tulo, lugar..." oninput="App.filters.apply()">
                        </div>

                        <!-- Date Range -->
                        <div class="form-group">
                            <label>Rango de Fechas</label>
                            <div class="date-row">
                                <input type="date" id="globalDateStart" class="input-field"
                                    onchange="App.filters.apply()">
                                <input type="date" id="globalDateEnd" class="input-field"
                                    onchange="App.filters.apply()">
                            </div>
                        </div>

                        <!-- Dynamic Checkboxes -->
                        <div id="filterContainerDelegation"></div>
                        <div id="filterContainerType"></div>
                        <div id="filterContainerPlace"></div>

                        <!-- Secondary Multi-selects -->
                        <!-- Full Width Organizer -->
                        <div id="filterContainerOrganizer"></div>

                        <div class="filter-group-row">
                            <!-- Access moved here effectively if needed, or just leave Access as is -->
                            <div id="filterContainerAccess" class="half-width"></div>
                        </div>

                        <!-- NEW LOCATION: Management/Administrative Filters -->
                        <div class="form-group" style="margin-top:0.5rem">
                            <label>Gesti√≥n</label>
                            <div class="toggles-grid">
                                <label class="toggle-item"><input type="checkbox" id="toggleCollab"
                                        onchange="App.filters.apply()"> Colaboraci√≥n</label>
                                <label class="toggle-item"><input type="checkbox" id="toggleSponsor"
                                        onchange="App.filters.apply()"> Patrocinio</label>
                                <label class="toggle-item"><input type="checkbox" id="toggleMuni"
                                        onchange="App.filters.apply()"> Serv. Municipales</label>
                                <label class="toggle-item"><input type="checkbox" id="toggleContract"
                                        onchange="App.filters.apply()"> Contratos</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Requisitos</label>
                            <div class="toggles-grid">
                                <label class="toggle-item"><input type="checkbox" id="togglePolice"
                                        onchange="App.filters.apply()"> üëÆ Polic√≠a</label>
                                <label class="toggle-item"><input type="checkbox" id="toggleStage"
                                        onchange="App.filters.apply()"> üé™ Escenario</label>
                                <label class="toggle-item"><input type="checkbox" id="toggleMega"
                                        onchange="App.filters.apply()"> üé§ Megafon√≠a</label>
                            </div>
                        </div>
                        <div id="filterContainerPublic"></div>

                        <!-- Numeric Ranges -->
                        <div class="form-group">
                            <label>Aforo / Participantes</label>
                            <div class="range-inputs">
                                <input type="number" id="filterCapMin" placeholder="Aforo Min" class="input-xs">
                                <input type="number" id="filterPartMin" placeholder="Partic. Min" class="input-xs">
                            </div>
                        </div>

                        <!-- Services Toggles -->
                        <!-- Old Service Toggles Removed -->
                    </div>
                </aside>

                <!-- Right: Results Table Preview -->
                <section class="filter-results-preview">
                    <header class="preview-header">
                        <span id="filtersBadgeCount">0 eventos encontrados</span>
                    </header>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Horario</th>
                                    <th>Evento / Tipo</th>
                                    <th>Delegaci√≥n</th>
                                    <th>Organiza</th>
                                    <th>Lugar</th>
                                    <th>Aforo/Part.</th>
                                    <th>Acceso</th>
                                    <th>Req.</th>
                                </tr>
                            </thead>
                            <tbody id="filtersTableBody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>

        <!-- TAB 2: AGENDA (CALENDAR) -->
        <main id="tab-agenda" class="view-container active">
            <div class="agenda-layout">
                <header class="agenda-quick-bar">
                    <div class="quick-filters">
                        <span class="label">R√°pidos:</span>
                        <!-- Quick Services -->
                        <div class="quick-toggles">
                            <button class="chip-toggle" onclick="App.agenda.toggleQuick('police')" id="chipPolice">üëÆ
                                Polic√≠a</button>
                            <button class="chip-toggle" onclick="App.agenda.toggleQuick('stage')" id="chipStage">üé™
                                Escenario</button>
                            <button class="chip-toggle" onclick="App.agenda.toggleQuick('mega')" id="chipMega">üé§
                                Megafon√≠a</button>
                        </div>
                        <div class="divider-v"></div>
                        <button class="btn-text-xs" onclick="App.agenda.resetQuick()">Limpiar</button>
                    </div>

                    <!-- Date Nav -->
                    <div class="date-nav">
                        <button class="icon-btn" onclick="App.agenda.prevWeek()">‚Üê</button>
                        <span id="weekLabel"
                            style="font-weight:600; font-size:0.9rem; min-width:140px; text-align:center"></span>
                        <button class="icon-btn" onclick="App.agenda.nextWeek()">‚Üí</button>
                    </div>

                    <!-- View Switcher -->
                    <div class="view-switcher-pill">
                        <button class="pill-btn active" onclick="App.agenda.setView('week')"
                            id="btnViewWeek">Semana</button>
                        <button class="pill-btn" onclick="App.agenda.setView('month')" id="btnViewMonth">Mes</button>
                        <button class="pill-btn" onclick="App.agenda.setView('list')" id="btnViewList">Lista</button>
                    </div>
                </header>

                <div class="agenda-content-area">
                    <!-- Week View -->
                    <div id="view-week" class="sub-view active">
                        <div id="weekGrid" class="week-grid"></div>
                    </div>

                    <!-- Month View -->
                    <div id="view-month" class="sub-view">
                        <div id="monthGrid" class="month-grid"></div>
                    </div>

                    <!-- List View -->
                    <div id="view-list" class="sub-view">
                        <div class="list-container" id="listContainer"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- TAB 3: REPORTS -->
        <main id="tab-reports" class="view-container">
            <div class="reports-layout">
                <!-- 1. GENERALES -->
                <section class="report-section">
                    <h3 class="section-title">1. Resumen General</h3>
                    <div class="kpi-row">
                        <div class="kpi-card">
                            <span class="label">Total Eventos</span>
                            <span class="value" id="kpiTotalEvents">0</span>
                        </div>
                        <div class="kpi-card">
                            <span class="label">D√≠as con Actividad</span>
                            <span class="value" id="kpiActiveDays">0</span>
                        </div>
                        <div class="kpi-card">
                            <span class="label">Total Horas</span>
                            <span class="value" id="kpiTotalHours">0</span>
                        </div>
                        <div class="kpi-card">
                            <span class="label">Media Eventos/D√≠a</span>
                            <span class="value" id="kpiAvgEvents">0</span>
                        </div>
                    </div>
                </section>

                <div class="grid-2col">
                    <!-- 2. DELEGACI√ìN -->
                    <section class="report-section">
                        <h3 class="section-title">2. Gesti√≥n por Delegaci√≥n</h3>
                        <div class="chart-container">
                            <canvas id="chartDelegationEvents"></canvas>
                        </div>
                        <div class="kpi-table-container">
                            <table class="kpi-table" id="tableDelegationHours">
                                <thead>
                                    <tr>
                                        <th>Delegaci√≥n</th>
                                        <th>Eventos</th>
                                        <th>Horas</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- 3. ORGANIZACI√ìN -->
                    <section class="report-section">
                        <h3 class="section-title">3. Organizaci√≥n e Impulso</h3>
                        <div class="kpi-mini-grid">
                            <div class="kpi-card sm">
                                <span class="label">Ayuntamiento</span>
                                <span class="value" id="kpiOrgAyto">0</span>
                            </div>
                            <div class="kpi-card sm">
                                <span class="label">Terceros</span>
                                <span class="value" id="kpiOrgThird">0</span>
                            </div>
                            <div class="kpi-card sm">
                                <span class="label">Con Colaboraci√≥n</span>
                                <span class="value" id="kpiCollab">0</span>
                            </div>
                            <div class="kpi-card sm">
                                <span class="label">Con Patrocinio</span>
                                <span class="value" id="kpiSponsor">0</span>
                            </div>
                        </div>
                        <div class="chart-container" style="height:200px; margin-top:1rem">
                            <canvas id="chartOrganizer"></canvas>
                        </div>
                    </section>
                </div>

                <!-- 4. P√öBLICO -->
                <section class="report-section">
                    <h3 class="section-title">4. Impacto y P√∫blico</h3>
                    <div class="kpi-row">
                        <div class="kpi-card">
                            <span class="label">Total P√∫blico Est.</span>
                            <span class="value" id="kpiTotalAudience">0</span>
                        </div>
                        <div class="kpi-card">
                            <span class="label">Media por Evento</span>
                            <span class="value" id="kpiAvgAudience">0</span>
                        </div>
                    </div>
                    <div class="grid-2col mt-4">
                        <div class="chart-container-sm">
                            <h4>Tipo de P√∫blico</h4>
                            <canvas id="chartPublicType"></canvas>
                        </div>
                        <div class="chart-container-sm">
                            <h4>Tipo de Acceso</h4>
                            <canvas id="chartAccessType"></canvas>
                        </div>
                    </div>
                </section>

                <!-- 5. ESPACIOS -->
                <section class="report-section">
                    <h3 class="section-title">5. Uso de Espacios</h3>
                    <div class="kpi-table-container scrollable">
                        <table class="kpi-table" id="tableSpaces">
                            <thead>
                                <tr>
                                    <th>Espacio</th>
                                    <th>Eventos</th>
                                    <th>D√≠as Ocupaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <div class="grid-2col">
                    <!-- 6. SERVICIOS -->
                    <section class="report-section">
                        <h3 class="section-title">6. Servicios T√©cnicos</h3>
                        <div class="kpi-table-container">
                            <table class="kpi-table" id="tableServices">
                                <thead>
                                    <tr>
                                        <th>Servicio</th>
                                        <th style="font-size:0.75rem">N¬∫ Ev.</th>
                                        <th style="font-size:0.75rem">L-V (h)</th>
                                        <th style="font-size:0.75rem">S-D (h)</th>
                                        <th>Total (h)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- 7. TEMPORALIDAD -->
                    <section class="report-section full-width" style="grid-column: 1 / -1; margin-top:2rem">
                        <h3 class="section-title">7. Temporalidad</h3>
                        <div class="grid-2col">
                            <div class="kpi-table-container">
                                <h4>Por Mes</h4>
                                <table class="kpi-table" id="tableMonth">
                                    <thead>
                                        <tr>
                                            <th>Mes</th>
                                            <th>Eventos</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="kpi-table-container">
                                <h4>Por D√≠a</h4>
                                <table class="kpi-table" id="tableWeekday">
                                    <thead>
                                        <tr>
                                            <th>D√≠a</th>
                                            <th>Eventos</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- 8. CONTROL -->
                <section class="report-section danger-zone">
                    <h3 class="section-title">8. Control de Calidad</h3>
                    <div class="kpi-row">
                        <div class="kpi-card warning">
                            <span class="label">Sin Hora (Todo el d√≠a)</span>
                            <span class="value" id="kpiNoTime">0</span>
                        </div>
                        <div class="kpi-card danger">
                            <span class="label">Datos Incompletos</span>
                            <span class="value" id="kpiIncomplete">0</span>
                            <small class="caption">Falta aforo, tipo o acceso</small>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- TAB 4: INCIDENTS -->
        <main id="tab-incidents" class="view-container">
            <div class="incidents-layout">
                <header class="incidents-header">
                    <div>
                        <h2>Gesti√≥n de Coincidencias</h2>
                        <p class="text-sm text-muted">Conflictos espaciales y de servicios</p>
                    </div>
                    <button class="btn-primary" onclick="App.incidents.exportPdf()">Descargar Informe</button>
                </header>

                <div class="incidents-dashboard-grid">
                    <div class="inc-stat danger">
                        <span class="label">Graves (Espacio)</span>
                        <span class="value" id="incHighCount">0</span>
                    </div>
                    <div class="inc-stat warning">
                        <span class="label">Alertas Servicios</span>
                        <span class="value" id="incMedCount">0</span>
                    </div>
                </div>

                <div class="incidents-list-container">
                    <table class="incidents-table">
                        <thead>
                            <tr>
                                <th>Gravedad</th>
                                <th>Conflicto</th>
                                <th>Eventos Implicados</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="incidentsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="app-footer">
            Delegaci√≥n de Actos P√∫blicos ¬∑ Ayuntamiento de Torremolinos
        </footer>
    </div>

    <!-- DETAILS DRAWER -->
    <div id="drawerOverlay" class="drawer-overlay hidden" onclick="App.ui.closeDrawer()">
        <aside class="drawer" onclick="event.stopPropagation()">
            <header>
                <button class="close-icon" onclick="App.ui.closeDrawer()"><i data-lucide="x"></i></button>
            </header>
            <div id="drawerContent"></div>
        </aside>
    </div>

    <script src="script.js"></script>
</body>

</html>